{"version":3,"file":"inserter-test.js","sourceRoot":"","sources":["../../ts/tests/inserter-test.ts"],"names":[],"mappings":"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","sourcesContent":["import QUnit from 'qunit';\nimport 'qunit-assertions-extra';\nimport broccoli, { Builder } from 'broccoli';\nimport { UnwatchedDir } from 'broccoli-source';\nimport quickTemp from 'quick-temp';\nimport {\n  ensureDirSync,\n  readFileSync,\n  outputFileSync,\n  removeSync,\n  readJSONSync,\n} from 'fs-extra';\nimport { join } from 'path';\nimport { Inserter } from '../inserter';\nimport BundleConfig from '../bundle-config';\nimport { BuildResult, Bundler } from '../bundler';\nconst { module: Qmodule, test } = QUnit;\n\nQmodule('inserter', function (hooks) {\n  let builder: Builder;\n  let upstream: string;\n  let publicAssetURL: string;\n  let bundleConfig: BundleConfig;\n  let buildResult: BuildResult;\n  let insertScriptsAt: string | undefined;\n  let insertStylesAt: string | undefined;\n\n  async function build() {\n    let inserter = new Inserter(\n      new UnwatchedDir(upstream),\n      { buildResult } as Bundler,\n      bundleConfig,\n      {\n        publicAssetURL,\n        insertScriptsAt,\n        insertStylesAt,\n      }\n    );\n    builder = new broccoli.Builder(inserter);\n    await builder.build();\n  }\n\n  function writeIndex(src: string) {\n    outputFileSync(join(upstream, 'index.html'), src);\n  }\n\n  function readIndex(): string {\n    return readFileSync(join(builder.outputPath, 'index.html'), 'utf8');\n  }\n\n  hooks.beforeEach(function (this: any) {\n    quickTemp.makeOrRemake(this, 'workDir', 'auto-import-inserter-tests');\n    ensureDirSync((upstream = join(this.workDir, 'upstream')));\n    buildResult = {\n      entrypoints: new Map(),\n      lazyAssets: [],\n    };\n    bundleConfig = new BundleConfig({\n      app: {\n        html: 'index.html',\n      },\n      vendor: { css: '/assets/vendor.css', js: '/assets/vendor.js' },\n    });\n    publicAssetURL = '/assets/';\n  });\n\n  hooks.afterEach(function (this: any) {\n    removeSync(this.workDir);\n    if (builder) {\n      return builder.cleanup();\n    }\n  });\n\n  test('does not error when we have nothing to insert', async function (assert) {\n    writeIndex('');\n    await build();\n    assert.expect(0);\n  });\n\n  test('errors when we cannot find a place for app js', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    writeIndex('');\n    try {\n      await build();\n      throw new Error('should not get here');\n    } catch (err: any) {\n      assert.contains(\n        err.message,\n        'ember-auto-import could not find a place to insert app scripts in index.html'\n      );\n    }\n  });\n\n  test('errors when we cannot find a place for app css', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    writeIndex('');\n    try {\n      await build();\n      throw new Error('should not get here');\n    } catch (err: any) {\n      assert.contains(\n        err.message,\n        'ember-auto-import could not find a place to insert app styles in index.html'\n      );\n    }\n  });\n\n  test('inserts app scripts after vendor.js', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    writeIndex(`<script src=\"/assets/vendor.js\"></script>`);\n    await build();\n    assert.equal(\n      readIndex(),\n      `<script src=\"/assets/vendor.js\"></script>\\n<script src=\"/assets/chunk.1.js\"></script>`\n    );\n  });\n\n  test('inserts fastboot scripts when using newer fastboot manifest', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    buildResult.lazyAssets.push('assets/chunk.2.js');\n    writeIndex(`<script src=\"/assets/vendor.js\"></script>`);\n    outputFileSync(\n      join(upstream, 'package.json'),\n      JSON.stringify({\n        fastboot: {\n          schemaVersion: 5,\n        },\n      })\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<script src=\"/assets/vendor.js\"></script>\\n<script src=\"/assets/chunk.1.js\"></script>\\n<fastboot-script src=\"/assets/chunk.2.js\"></fastboot-script>`\n    );\n  });\n\n  test('inserts scripts into older fastboot manifest', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    buildResult.lazyAssets.push('assets/chunk.2.js');\n    writeIndex(`<script src=\"/assets/vendor.js\"></script>`);\n    outputFileSync(\n      join(upstream, 'package.json'),\n      JSON.stringify({\n        fastboot: {\n          schemaVersion: 3,\n          manifest: {\n            vendorFiles: ['something.js'],\n          },\n        },\n      })\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<script src=\"/assets/vendor.js\"></script>\\n<script src=\"/assets/chunk.1.js\"></script>`\n    );\n    assert.deepEqual(readJSONSync(join(builder.outputPath, 'package.json')), {\n      fastboot: {\n        schemaVersion: 3,\n        manifest: {\n          vendorFiles: [\n            'something.js',\n            'assets/chunk.1.js',\n            'assets/chunk.2.js',\n          ],\n        },\n      },\n    });\n  });\n\n  test('inserts app styles after vendor.css', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    writeIndex(`<link rel=\"stylesheet\" href=\"/assets/vendor.css\"/>`);\n    await build();\n    assert.equal(\n      readIndex(),\n      `<link rel=\"stylesheet\" href=\"/assets/vendor.css\"/>\\n<link rel=\"stylesheet\" href=\"/assets/chunk.1.css\"/>`\n    );\n  });\n\n  test('inserts app scripts after customized vendor.js', async function (assert) {\n    bundleConfig = new BundleConfig({\n      app: {\n        html: 'index.html',\n      },\n      vendor: { css: '/assets/vendor.css', js: '/assets/rodnev.js' },\n    });\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    writeIndex(`<script src=\"/assets/rodnev.js\"></script>`);\n    await build();\n    assert.equal(\n      readIndex(),\n      `<script src=\"/assets/rodnev.js\"></script>\\n<script src=\"/assets/chunk.1.js\"></script>`\n    );\n  });\n\n  test('inserts app styles after customized vendor.css', async function (assert) {\n    bundleConfig = new BundleConfig({\n      app: {\n        html: 'index.html',\n      },\n      vendor: { css: '/assets/rodnev.css', js: '/assets/rodnev.js' },\n    });\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    writeIndex(`<link rel=\"stylesheet\" href=\"/assets/rodnev.css\"/>`);\n    await build();\n    assert.equal(\n      readIndex(),\n      `<link rel=\"stylesheet\" href=\"/assets/rodnev.css\"/>\\n<link rel=\"stylesheet\" href=\"/assets/chunk.1.css\"/>`\n    );\n  });\n\n  test('uses customized publicAssetURL for JS', async function (assert) {\n    publicAssetURL = 'https://cdn.com/4321/assets/';\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    writeIndex(`<script src=\"/assets/vendor.js\"></script>`);\n    await build();\n    assert.equal(\n      readIndex(),\n      `<script src=\"/assets/vendor.js\"></script>\\n<script src=\"https://cdn.com/4321/assets/chunk.1.js\"></script>`\n    );\n  });\n\n  test('uses customized publicAssetURL for css', async function (assert) {\n    publicAssetURL = 'https://cdn.com/4321/assets/';\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    writeIndex(`<link rel=\"stylesheet\" href=\"/assets/vendor.css\"/>`);\n    await build();\n    assert.equal(\n      readIndex(),\n      `<link rel=\"stylesheet\" href=\"/assets/vendor.css\"/>\\n<link rel=\"stylesheet\" href=\"https://cdn.com/4321/assets/chunk.1.css\"/>`\n    );\n  });\n\n  test('can customize script insertion location', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    insertScriptsAt = 'auto-import-script';\n    writeIndex(\n      `<auto-import-script entrypoint=\"app\"></auto-import-script>\\n<script src=\"/assets/vendor.js\"></script>`\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<script src=\"/assets/chunk.1.js\"></script>\\n<script src=\"/assets/vendor.js\"></script>`\n    );\n  });\n\n  test('customized script insertion supports fastboot-script', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    buildResult.lazyAssets.push('assets/chunk.2.js');\n    outputFileSync(\n      join(upstream, 'package.json'),\n      JSON.stringify({\n        fastboot: {\n          schemaVersion: 5,\n        },\n      })\n    );\n    insertScriptsAt = 'auto-import-script';\n    writeIndex(\n      `<auto-import-script entrypoint=\"app\" data-foo=\"bar\"></auto-import-script>\\n<script src=\"/assets/vendor.js\"></script>`\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<script src=\"/assets/chunk.1.js\" data-foo=\"bar\"></script>\\n<fastboot-script src=\"/assets/chunk.2.js\" data-foo=\"bar\"></fastboot-script>\\n<script src=\"/assets/vendor.js\"></script>`\n    );\n  });\n\n  test('can customize attributes on inserted script', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    insertScriptsAt = 'auto-import-script';\n    writeIndex(\n      `<div><auto-import-script entrypoint=\"app\" defer data-foo=\"bar\"></auto-import-script></div>`\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<div><script src=\"/assets/chunk.1.js\" defer data-foo=\"bar\"></script></div>`\n    );\n  });\n\n  test('removes unused custom script element', async function (assert) {\n    insertScriptsAt = 'auto-import-script';\n    writeIndex(\n      `<div><auto-import-script entrypoint=\"app\"></auto-import-script></div><script src=\"/assets/vendor.js\"></script>`\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<div></div><script src=\"/assets/vendor.js\"></script>`\n    );\n  });\n\n  test('errors when custom script element is missing entrypoint', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    insertScriptsAt = 'auto-import-script';\n    writeIndex('<auto-import-script />');\n    try {\n      await build();\n      throw new Error('should not get here');\n    } catch (err: any) {\n      assert.contains(\n        err.message,\n        '<auto-import-script/> element in index.html is missing required entrypoint attribute'\n      );\n    }\n  });\n\n  test('errors when custom element is configured but not present', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.js']);\n    insertScriptsAt = 'auto-import-script';\n    writeIndex('<uto-import-script entrypoint=\"app\"></uto-import-script>');\n    try {\n      await build();\n      throw new Error('should not get here');\n    } catch (err: any) {\n      assert.contains(\n        err.message,\n        'ember-auto-import cannot find <auto-import-script entrypoint=\"app\"> in index.html'\n      );\n    }\n  });\n\n  test('can customize style insertion location', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    insertStylesAt = 'auto-import-style';\n    writeIndex(\n      `<auto-import-style entrypoint=\"app\"></auto-import-style>\\n<link rel=\"stylesheet\" href=\"/assets/vendor.css\"/>`\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<link rel=\"stylesheet\" href=\"/assets/chunk.1.css\"/>\\n<link rel=\"stylesheet\" href=\"/assets/vendor.css\"/>`\n    );\n  });\n\n  test('can customize attributes on inserted style', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    insertScriptsAt = 'auto-import-style';\n    writeIndex(\n      `<div><auto-import-style entrypoint=\"app\" data-baz data-foo=\"bar\"></auto-import-style></div>`\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<div><link rel=\"stylesheet\" href=\"/assets/chunk.1.css\" data-baz data-foo=\"bar\"/></div>`\n    );\n  });\n\n  test('removes unused custom style element', async function (assert) {\n    insertScriptsAt = 'auto-import-style';\n    writeIndex(\n      `<div><auto-import-style entrypoint=\"app\"></auto-import-style></div><link rel=\"styleshee\" href=\"/assets/vendor.css\"/>`\n    );\n    await build();\n    assert.equal(\n      readIndex(),\n      `<div></div><link rel=\"styleshee\" href=\"/assets/vendor.css\"/>`\n    );\n  });\n\n  test('errors when custom style element is missing entrypoint', async function (assert) {\n    buildResult.entrypoints.set('app', ['assets/chunk.1.css']);\n    insertStylesAt = 'auto-import-style';\n    writeIndex('<auto-import-style></auto-import-style');\n    try {\n      await build();\n      throw new Error('should not get here');\n    } catch (err: any) {\n      assert.contains(\n        err.message,\n        '<auto-import-style/> element in index.html is missing required entrypoint attribute'\n      );\n    }\n  });\n});\n"]}